version: "3.9"

volumes:
  data:
    driver: local

services:
  asgard-data:
    image: navitia/asgard-data-downloader:latest
    environment:
        - MINIO_KEY=asgard_usr
        - MINIO_SECRET=secret
        - MINIO_HOST=localhost:9000
        - MINIO_BUCKET=asgard
        - MINIO_COVERAGE=europe 
        - MINIO_VALHALLA_VERSION=3.1.4
        
    volumes:
      - data:/data/valhalla
    deploy:
      mode: global
      restart_policy:
        condition: none
            
  asgard-valhalla-service:
    image: navitia/asgard-valhalla-service:${ASGARD_APP_TAG}
    depends_on:
      - "asgard-data"
    volumes:
      - data:/data/valhalla
   
    ports:
      - 8002:8002
      
    deploy:
      mode: global
      restart_policy:
        condition: any

    entrypoint: ["sh", "-c", "wait-for-data.sh && valhalla_service /data/valhalla/valhalla.json 1"]

  asgard:
    image: navitia/asgard-app:${ASGARD_APP_TAG}
    depends_on:
      - "asgard-data"
      - "asgard-valhalla-service"
        
    volumes:
      - data:/data/valhalla
      
    ports:
      - "6000:6000"
      - "8080:8080"
    restart: always

    entrypoint: ["sh", "-c", "wait-for-data.sh && /usr/bin/asgard"]

    environment:
      - ASGARD_SOCKET_PATH=tcp://*:6000
      - ASGARD_WALKING_CACHE_SIZE=50000
      - ASGARD_BIKE_CACHE_SIZE=50000
      - ASGARD_CAR_CACHE_SIZE=50000
      - ASGARD_NB_THREADS=3
      - ASGARD_METRICS_BINDING=0.0.0.0:8181
      - ASGARD_VALHALLA_SERVICE_URL=asgard-valhalla-service:8002
      - ASGARD_VALHALLA_CONF=/data/valhalla/valhalla.json
    deploy:
      mode: global
      restart_policy:
        condition: any
